from django.contrib import admin
from .models import PersonaAtendida, LLamada, Ticket
import openpyxl
from django.http import FileResponse
from datetime import datetime



@admin.action(description='Descargar las llamadas seleccionadas en Excel')
def descargarLlamadas(modelAdmin, request, queryset): 

    hoja_excel = openpyxl.Workbook()
    campos = ['Fecha Registro de Llamada', 'Nombre Persona Atendida', 'Departamento Persona Atendida', 'Motivo de Llamada']

    hoja_excel.active.append(campos)

    for llamada in queryset:
        fila = [
            llamada.fecha_registro,
            llamada.persona_atendida.nombre,
            llamada.persona_atendida.departamento.nombre,
            llamada.motivo
        ]

        hoja_excel.active.append(fila)
    
    fechaYHoraActual = datetime.now().strftime("%m-%d-%Y_%H-%M-%S")

    hoja_excel.save(f'C:/Users/opdbd07/Desktop/INABIE_APPS_01/INABIE_Dev_Env/Lib/site-packages/django/bin/INABIE_TIC/Tecnologia/llamadas_telefonicas/llamadas_telefonicas_{fechaYHoraActual}.xlsx')

    response = FileResponse(open(f'C:/Users/opdbd07/Desktop/INABIE_APPS_01/INABIE_Dev_Env/Lib/site-packages/django/bin/INABIE_TIC/Tecnologia/llamadas_telefonicas/llamadas_telefonicas_{fechaYHoraActual}.xlsx', 'rb'))

    return response

class PersonaAtendidaAdmin(admin.ModelAdmin):
    persona_atendida_fields = tuple([f.name for f in PersonaAtendida._meta.fields])
    list_display = persona_atendida_fields
    list_filter = ('departamento', 'division')
    search_fields = ('nombre','departamento__nombre', 'division__nombre')
    autocomplete_fields = ('departamento', 'division')
    

class LlamadaAdmin(admin.ModelAdmin):
    llamada_fields = tuple([f.name for f in LLamada._meta.fields])
    list_display = llamada_fields
    list_filter = ('fecha_registro', )
    date_hierarchy = 'fecha_registro'
    search_fields = ('persona_atendida__nombre','motivo')
    autocomplete_fields = ('persona_atendida', )
    actions = [descargarLlamadas]

class TicketAdmin(admin.ModelAdmin):
    list_display = tuple([f.name for f in Ticket._meta.fields])
    date_hierarchy = 'fecha_registro'
    list_filter = ('estado', 'prioridad', 'fecha_registro')
    search_fields = ('persona_asignada__nombre','motivo_del_requerimiento', 'transferido_por__nombre', 'departamento_solicitador__nombre')
    autocomplete_fields = ('persona_asignada', 'departamento_solicitador', 'transferido_por')


admin.site.register(PersonaAtendida, PersonaAtendidaAdmin)
admin.site.register(LLamada, LlamadaAdmin)
admin.site.register(Ticket, TicketAdmin)