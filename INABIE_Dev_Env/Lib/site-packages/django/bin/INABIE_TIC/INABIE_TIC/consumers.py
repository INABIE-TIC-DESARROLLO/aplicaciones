
from cgitb import text
import json
from asgiref.sync import async_to_sync, sync_to_async
from channels.generic.websocket import AsyncWebsocketConsumer
from django.http import FileResponse
from datetime import datetime


from Recepcion.models import Turno
from channels.db import database_sync_to_async
from django.dispatch import receiver
from django.db.models.signals import post_save, post_delete
import channels.layers

from django.core import serializers

from AdministracionSistema.models import Provincia, Municipio

class WSTurnos(AsyncWebsocketConsumer):
    
    async def connect(self):

        await self.accept()

        global WSTurnos_instance 
        WSTurnos_instance = self
     

    


    async def receive(self, text_data=None, bytes_data=None):

        turnos_siendo_atendidos = await self.get_turnosSiendoAtendidos()
        turnos_en_espera = await self.get_turnosEnEspera()
        res = list(turnos_siendo_atendidos) + list(turnos_en_espera)

        data = {}
        data["turnos_en_espera"] = []
        data["turnos_siendo_atendidos"] = []

        for turno in res:
            turno = {

                "departamento_servicio" : turno.departamento_servicio,
                "division_departamento_servicio" : turno.division_departamento_servicio, 
                "nombre_persona_atendida" : turno.persona_atendida.nombre, 
                "cedula_rnc_persona_atendida" : turno.persona_atendida.cedula_rnc, 
                "codigo" : turno.codigo, 
                "preferencial" : turno.preferencial, 
                "estado" : turno.estado
            }

            if turno["estado"] == "ATENDIENDO":
                data["turnos_siendo_atendidos"].append(turno)

            if turno["estado"] == "EN ESPERA":
                data["turnos_en_espera"].append(turno)

        res_json = json.dumps(data)

        await self.send(res_json)
    
    @database_sync_to_async
    def get_turnosSiendoAtendidos(self):
 
        return Turno.objects.filter(estado = "ATENDIENDO")

    @database_sync_to_async
    def get_turnosEnEspera(self):
 
        return Turno.objects.filter(estado = "EN ESPERA")

    async def send_message(self, event):
        data = {}
        data["turnos_en_espera"] = []
        data["turnos_siendo_atendidos"] = []
        data["turnos_atendidos"] = []
        data["turnos_descartados"] = []

        if event['text']['estado'] == "ATENDIENDO":     
            data["turnos_siendo_atendidos"].append(event['text'])


        if event['text']['estado'] == "EN ESPERA": 
            data["turnos_en_espera"].append(event['text']) 

        if event['text']['estado'] == "ATENDIDO": 
            data["turnos_atendidos"].append(event['text']) 

        if event['text']['estado'] == "DESCARTADO": 
            data["turnos_descartados"].append(event['text']) 


        res = json.dumps(data)   

        await self.send(text_data= res)

    @receiver(post_save, sender=Turno)
    def muestraTurnos(sender, instance, created, **kwargs):

        message = {
            "nombre_persona_atendida": instance.persona_atendida.nombre,
            "cedula_rnc_persona_atendida": instance.persona_atendida.cedula_rnc,
            "codigo": instance.codigo,
            "preferencial": instance.preferencial,
            "estado": instance.estado,
            "departamento_servicio" : instance.departamento_servicio,
            "division_departamento_servicio" : instance.division_departamento_servicio, 

        }
        
        channel_layer = channels.layers.get_channel_layer()

        async_to_sync(channel_layer.send)(WSTurnos_instance.channel_name, {
        "type": "send.message",
        "text": message,
        })

        



        


    async def disconnect(self, close_code):
        print("Se ha cerrado el websocket")

#----------------------- GEOAPP -----------------------------
from ComprasYContrataciones.models import Oferente, Escuela
from AdministracionSistema.models import Provincia, Municipio

class Geoapp(AsyncWebsocketConsumer):

    
    
    async def connect(self):


        await self.accept()

        global geoapp_instance 
        geoapp_instance = self

        data = {}
        oferentes = json.loads(await self.getOferentes())
        escuelas = json.loads(await self.getEscuelas())
        data['oferentes'] = {}
        data['escuelas'] = {}
        
        for oferente in oferentes:
            data['oferentes'][oferente['pk']] = oferente['fields']



        for escuela in escuelas:
            data['escuelas'][escuela['pk']] = escuela['fields']




        res = json.dumps(data)

        await self.send(text_data= res)

    @database_sync_to_async
    def getEscuelas(self):

        return serializers.serialize('json', Escuela.objects.all().select_related('provincia', 'municipio'), use_natural_foreign_keys=True, use_natural_primary_keys=True) 

         

    @database_sync_to_async
    def getOferentes(self):

        return serializers.serialize('json', Oferente.objects.all().select_related('provincia', 'municipio'), use_natural_foreign_keys=True, use_natural_primary_keys=True)


    def receive(self, text_data=None, bytes_data=None):
        jsonData = json.loads(text_data)

        if jsonData["entidad"] == 'escuela':
            escuela = Escuela.objects.get(codigo = jsonData['codigo'])
            escuela.lote = jsonData['nuevoValorLote']
            escuela.save()

        elif jsonData["entidad"] == 'oferente':
            oferente = Oferente.objects.get(cedula_rnc = jsonData['cedula_rnc'])
            oferente.lote_asignado = jsonData['nuevoValorLote']
            oferente.save()
    
    # @database_sync_to_async
    # def getOferente(self, valor):
    #     return Oferente.objects.get(cedula_rnc = valor)

    # @database_sync_to_async
    # def getEscuela(self, valor):
    #     return Escuela.objects.get(codigo = valor)

    
    async def disconnect(self, close_code):
        print("Se ha cerrado el websocket")

    async def send_message(self, event):  

        await self.send(text_data= event['text'])

    @receiver(post_save, sender=Escuela)
    def sendEscuela(sender, instance, created, **kwargs):

        fieldsNames = [f.name for f in Escuela._meta.fields]
        instanceDict = vars(instance)
        message = {}

        for field in fieldsNames:
            if field == 'provincia':
                message[field] = Provincia.objects.get(id = instanceDict['provincia_id']).nombre
            elif field == 'municipio':
                message[field] = Municipio.objects.get(id = instanceDict['municipio_id']).nombre
            else:
                message[field] = instanceDict[field]
        
        channel_layer = channels.layers.get_channel_layer()

        async_to_sync(channel_layer.send)(geoapp_instance.channel_name, {
        "type": "send.message",
        "text": json.dumps(message),
        })

    @receiver(post_save, sender=Oferente)
    def sendOferente(sender, instance, created, **kwargs):

        fieldsNames = [f.name for f in Oferente._meta.fields]
        instanceDict = vars(instance)
        message = {}

        for field in fieldsNames:
            if field == 'provincia':
                message[field] = Provincia.objects.get(id = instanceDict['provincia_id']).nombre
            elif field == 'municipio':
                message[field] = Municipio.objects.get(id = instanceDict['municipio_id']).nombre
            else:
                message[field] = instanceDict[field]
        
        channel_layer = channels.layers.get_channel_layer()


        async_to_sync(channel_layer.send)(geoapp_instance.channel_name, {
        "type": "send.message",
        "text": json.dumps(message),
        })

    @receiver(post_delete, sender=Escuela)
    def deleteEscuela(sender, instance, **kwargs):

        instanceDict = vars(instance)
        message = {'codigo': instanceDict['codigo'], 'accion': 'eliminar'}
        
        channel_layer = channels.layers.get_channel_layer()

        async_to_sync(channel_layer.send)(geoapp_instance.channel_name, {
        "type": "send.message",
        "text": json.dumps(message),
        })
        
    
    @receiver(post_delete, sender=Oferente)
    def deleteOferente(sender, instance, **kwargs):

        instanceDict = vars(instance)
        message = {'cedula_rnc': instanceDict['cedula_rnc'], 'accion': 'eliminar'}
        
        channel_layer = channels.layers.get_channel_layer()

        async_to_sync(channel_layer.send)(geoapp_instance.channel_name, {
        "type": "send.message",
        "text": json.dumps(message),
        })
        
    