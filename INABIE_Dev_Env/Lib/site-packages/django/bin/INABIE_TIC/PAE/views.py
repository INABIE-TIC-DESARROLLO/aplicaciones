from django.shortcuts import render
from AdministracionSistema.models import Provincia, Municipio
from django.contrib.auth import authenticate, login, logout
from django.shortcuts import redirect
from .forms import LoginForm
from django.contrib.auth.decorators import login_required
from .models import Oferente, Escuela


# Create your views here.
@login_required
def GeoAppHome(request):

    regionales = [p.regional_asociada for p in Provincia.objects.all()]
    distritos = [m.distrito_asociado for m in Municipio.objects.all()]
    provincias = [p.nombre for p in Provincia.objects.all()]
    municipios = [m.nombre for m in Municipio.objects.all()]
    
    if request.method == 'GET':

        if request.user.is_authenticated:
            return render(request, '../templates/principal/index.html', {"regionales": regionales, "distritos": distritos, "provincias": provincias, "municipios": municipios, "user": request.user})
        else:
            form = LoginForm()
            return render(request, '../templates/login.html', {"form": form, "error": ""})

    elif request.method == 'POST':
        username = request.POST['username']
        password = request.POST['password']
        user = authenticate(request, username=username, password=password)
        if user is not None:
            login(request, user)
            return render(request, '../templates/principal/index.html', {"regionales": regionales, "distritos": distritos, "provincias": provincias, "municipios": municipios, "user": user})

        else:
            form = LoginForm()
            return render(request, '../templates/login.html', {"form": form, "error": "Los datos son incorrectos."})


def logout_view(request):
    logout(request) 
    return redirect('/geoapp/') 

# def GeoAppLogin(request):

#     if request.method == 'POST':
#         username = request.POST['username']
#         password = request.POST['password']
#         user = authenticate(request, username=username, password=password)
#         if user is not None:
#             login(request, user)
#             # return render(request, '../templates/principal/index.html', {"regionales": regionales, "distritos": distritos, "provincias": provincias, "municipios": municipios})
#             # return redirect("/geoapp/webapp", kwargs={"user": user})
#             return redirect(reverse(GeoAppHome, kwargs={"user": user}))

#         else:
#             return HttpResponse("<h1>Los datos son incorrectos</h1>")
    
#     else:

#         form = LoginForm()
#         return render(request, '../templates/login.html', {"form": form})

def consulta_oferentes(request):
    if request.method == "GET":
        return render(request, "../templates/consultas/oferentes.html", {"oferente": "vacio"})
    elif request.method == "POST":
        try:
            oferente = Oferente.objects.get(cedula_rnc = request.POST["cedula_rnc"])
        except:
            oferente = None

        return render(request, "../templates/consultas/oferentes.html", {"oferente": oferente})

def consulta_centros_educativos(request):
    if request.method == "GET":
        return render(request, "../templates/consultas/centros_educativos.html", {"centro_educativo": "vacio"})
    elif request.method == "POST":
        try:
           centro_educativo = Escuela.objects.get(centro_codigo = request.POST["codigo"])
        except:
           centro_educativo = None

        return render(request, "../templates/consultas/centros_educativos.html", {"centro_educativo": centro_educativo})