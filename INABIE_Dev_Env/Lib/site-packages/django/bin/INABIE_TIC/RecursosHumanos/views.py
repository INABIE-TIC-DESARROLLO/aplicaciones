from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required
from .forms import PermisoForm
from .models import Empleado, Permiso
from datetime import datetime
from INABIE_TIC import settings
from django.core.mail import send_mail

# Create your views here.
@login_required
def formularioPermiso(request):
    request.session.set_expiry(1200)

    try:
        empleado = Empleado.objects.get(usuario = request.user.username)
    except:
        request.session['message'] = 'Usted no está registrado/a en la base de datos de recursos humanos. Por favor, llame a recursos humanos para que lo registren y luego vuelva a intentar acceder al formulario.'
        return redirect('/error')

    fecha_actual = datetime.strftime(datetime.now().date(), "%Y-%m-%d") 

    if request.method == 'GET':
        return render(request, '../templates/formulario_permisos.html', {"empleado": empleado, "fecha_actual": fecha_actual})
    if request.method == 'POST':
        
        if 'archivo-evidencia' in request.FILES:
            archivo_adjuntado = request.FILES['archivo-evidencia']
        else:
            archivo_adjuntado = None

        permiso = Permiso(
            empleado = empleado,
            fecha_solicitud = datetime.now().date(),
            fecha_permiso = request.POST['fecha_permiso'],
            desde_hora = request.POST['desde_hora'],
            hasta_hora = request.POST['hasta_hora'],
            tiempo = (datetime.strptime(request.POST['hasta_hora'],"%H:%M") - datetime.strptime(request.POST['desde_hora'], "%H:%M")).total_seconds() / 60, #cantidad de minutos
            justificacion =  request.POST['justificacion'],
            archivo_evidencia = archivo_adjuntado,
            estado = 'PENDIENTE'
            
        )

        permiso.save()

        encargado = Empleado.objects.get(cargo__icontains = 'encargado', departamento = empleado.departamento, division = empleado.division)

        send_mail(subject = f'Solicitud de aprobación de permiso de {request.user.username}', 
                  message = f'Saludos, \n\n Esta es una notificación de solicitud de aprobación de un nuevo permiso. Por favor, revise la plataforma en el siguiente link para más detalles: \n\n http://{request.META["HTTP_HOST"]}/rrhh/panel-permisos-encargados \n\n\n' ,
                  from_email= settings.DEFAULT_FROM_EMAIL,
                  recipient_list = [f'{encargado.usuario}@inabie.gob.do'],
                  fail_silently=False,
        
                  )

        send_mail(subject = f'Nueva solicitud de aprobación de permiso de {request.user.username}', 
                  message = f'Saludos, \n\n Esta es una notificación de solicitud de aprobación de un nuevo permiso. Por favor, revise la plataforma en el siguiente link para más detalles: \n\n http://{request.META["HTTP_HOST"]}/admin/RecursosHumanos/permiso/ \n\n\n' ,
                  from_email= settings.DEFAULT_FROM_EMAIL,
                  recipient_list = ['betsy.reyes@inabie.gob.do', 'mario.paniagua@inabie.gob.do', 'sularka.perez@inabie.gob.do', 'wirjin.sanchez@inabie.gob.do', 'maigualida.mena@inabie.gob.do'],
                  fail_silently=False,
        
                  )
        
        return render(request, '../templates/formulario_enviado.html', {})

@login_required
def panelPermisosEncargados(request):
    request.session.set_expiry(600)

    usuario_empleado = Empleado.objects.get(usuario = request.user.username) #usuario del encargado
    empleados = Empleado.objects.filter(departamento = usuario_empleado.departamento, division = usuario_empleado.division) #obtener los empleados del departamento del usuario consultante
    

    if request.method == 'GET':
        cargo_lower = usuario_empleado.cargo.lower()
        cargo_split = cargo_lower.split(" ")
        if ('encargado' in cargo_split or 'encargada' in cargo_split) or request.user.is_superuser:
            permisos = Permiso.objects.order_by('-fecha_permiso')
            return render(request, '../templates/panel_permisos_encargados.html', {"empleados": empleados, "permisos": permisos})
        else:
            return render(request, '../templates/acceso_restringido.html', {})


    elif request.method == 'POST':

        if 'permisos' in request.POST:#FILTRO 
            # filtro para todos los empleados del departamento
            if request.POST['permisos'] == 'todos' and request.POST['empleado'] == 'TODOS':
                
                if request.POST['fecha_solicitud'] == '' and request.POST['fecha_permiso'] == '':
                    permisos = Permiso.objects.filter(empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division).order_by('-fecha_permiso')
                elif request.POST['fecha_solicitud'] != '' and request.POST['fecha_permiso'] == '':
                    permisos = Permiso.objects.filter(fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division)
                elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] == '':
                    permisos = Permiso.objects.filter(fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division)
                elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] != '':
                    permisos = Permiso.objects.filter(fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division)
            elif request.POST['permisos'] != 'todos' and request.POST['empleado'] == 'TODOS':
                if request.POST['fecha_solicitud'] == '' and request.POST['fecha_permiso'] == '':
                    permisos = Permiso.objects.filter(estado = request.POST['permisos'], empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division)
                elif request.POST['fecha_solicitud'] != '' and request.POST['fecha_permiso'] == '':
                    permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division)
                elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] == '':
                    permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division)
                elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] != '':
                    permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division)
            else: #filtro para empleado en especifico del departamento
                if request.POST['permisos'] == 'todos':
                
                    if request.POST['fecha_solicitud'] == '' and request.POST['fecha_permiso'] == '':
                        permisos = Permiso.objects.filter(empleado = request.POST['empleado']).order_by('-fecha_permiso')
                    elif request.POST['fecha_solicitud'] != '' and request.POST['fecha_permiso'] == '':
                        permisos = Permiso.objects.filter(fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado = request.POST['empleado'])
                    elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] == '':
                        permisos = Permiso.objects.filter(fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), empleado = request.POST['empleado'])
                    elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] != '':
                        permisos = Permiso.objects.filter(fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado = request.POST['empleado'])
                elif request.POST['permisos'] != 'todos':
                    if request.POST['fecha_solicitud'] == '' and request.POST['fecha_permiso'] == '':
                        permisos = Permiso.objects.filter(estado = request.POST['permisos'], empleado = request.POST['empleado'])
                    elif request.POST['fecha_solicitud'] != '' and request.POST['fecha_permiso'] == '':
                        permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado = request.POST['empleado'])
                    elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] == '':
                        permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), empleado = request.POST['empleado'])
                    elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] != '':
                        permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado = request.POST['empleado'])
        
            return render(request, '../templates/panel_permisos_encargados.html', {"empleados": empleados, "permisos": permisos})

        else: #Aprobar o denegar

            if 'permiso-aprobado' in request.POST:
                permiso = Permiso.objects.filter(id=request.POST['permiso-aprobado'])
                permiso.update(estado='APROBADO', comentario= request.POST['comentario'])
                
                send_mail(subject = 'Permiso Aprobado', 
                  message = f'Tienes un nuevo permiso aprobado, \n\n Por favor, revisa la plataforma en el siguiente link para más detalles: \n\n http://{request.META["HTTP_HOST"]}/rrhh/panel-permisos-empleados \n\n\n' ,
                  from_email= settings.DEFAULT_FROM_EMAIL,
                  recipient_list = [f'{permiso[0].empleado.usuario}@inabie.gob.do'],
                  fail_silently=False,
        
                  )

            if 'permiso-denegado' in request.POST:
                permiso = Permiso.objects.filter(id=request.POST['permiso-denegado'])
                permiso.update(estado='DENEGADO', comentario= request.POST['comentario'])

                send_mail(subject = 'Permiso Denegado', 
                  message = f'Tienes un nuevo permiso denegado, \n\n Por favor, revisa la plataforma en el siguiente link para más detalles: \n\n http://{request.META["HTTP_HOST"]}/rrhh/panel-permisos-empleados \n\n\n' ,
                  from_email= settings.DEFAULT_FROM_EMAIL,
                  recipient_list = [f'{permiso[0].empleado.usuario}@inabie.gob.do'],
                  fail_silently=False,
        
                )
                
            permisos = Permiso.objects.filter(empleado__departamento = usuario_empleado.departamento, empleado__division = usuario_empleado.division)
            return render(request, '../templates/panel_permisos_encargados.html', {"empleados": empleados, "permisos": permisos})



@login_required
def panelPermisosEmpleados(request):
    request.session.set_expiry(2400)

    usuario_empleado = Empleado.objects.get(usuario = request.user.username)

    if request.method == 'GET':
        permisos = Permiso.objects.filter(empleado = usuario_empleado).order_by('-fecha_permiso')
        return render(request, '../templates/panel_permisos_empleados.html', {"permisos": permisos})


    elif request.method == 'POST':

        if 'permisos' in request.POST:#FILTRO 
            
            if request.POST['permisos'] == 'todos':
                
                if request.POST['fecha_solicitud'] == '' and request.POST['fecha_permiso'] == '':
                    permisos = Permiso.objects.filter(empleado = usuario_empleado.cedula).order_by('-fecha_permiso')
                elif request.POST['fecha_solicitud'] != '' and request.POST['fecha_permiso'] == '':
                    permisos = Permiso.objects.filter(fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado = usuario_empleado.cedula)
                elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] == '':
                    permisos = Permiso.objects.filter(fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), empleado = usuario_empleado.cedula)
                elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] != '':
                    permisos = Permiso.objects.filter(fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado = usuario_empleado.cedula)
            elif request.POST['permisos'] != 'todos':
                if request.POST['fecha_solicitud'] == '' and request.POST['fecha_permiso'] == '':
                    permisos = Permiso.objects.filter(estado = request.POST['permisos'], empleado = usuario_empleado.cedula)
                elif request.POST['fecha_solicitud'] != '' and request.POST['fecha_permiso'] == '':
                    permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado = usuario_empleado.cedula)
                elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] == '':
                    permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), empleado = usuario_empleado.cedula)
                elif request.POST['fecha_permiso'] != '' and request.POST['fecha_solicitud'] != '':
                    permisos = Permiso.objects.filter(estado = request.POST['permisos'], fecha_permiso = datetime.strptime(request.POST['fecha_permiso'], "%Y-%m-%d"), fecha_solicitud = datetime.strptime(request.POST['fecha_solicitud'], "%Y-%m-%d"), empleado = usuario_empleado.cedula)
        
            return render(request, '../templates/panel_permisos_empleados.html', {"permisos": permisos})

@login_required
def reportes_rrhh(request):
    return render(request, '../templates/panel_reportes.html', {})

def aplicaciones_recursos_humanos(request):
    return render(request, '../templates/aplicaciones_recursos_humanos.html', {})
        

        
