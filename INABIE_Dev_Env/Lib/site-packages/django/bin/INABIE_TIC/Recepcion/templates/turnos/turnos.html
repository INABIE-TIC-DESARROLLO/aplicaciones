<!DOCTYPE html>
<html lang="en">
    <head>
        {% load static %}
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Turnos</title>
        {% comment %} <link rel="stylesheet" href="{% static '/turnos.css' %}"> {% endcomment %}
        <link rel="stylesheet" href="{% static '/bootstrap-5.1.3-dist/css/bootstrap.css' %}">

        <style>
          body{
              display: flex;
              justify-content: center;

          }

          .table{
              width: 49%;

          }

          .codigo{
              color: #002c5e;
          }

          .modal-body{
            
            background: #002c5e;
            color: rgb(236, 236, 236);
            text-align: center;
          }

          .modal-body .codigo-turno-llamado{
            font-size: 10rem;
            color: tomato;
          }

          .modal-body span{
            font-size: 3rem;
          }

          .modal-body h2, h3{
            font-size: 4rem;
            color: tomato;

          }

          table{
            height: fit-content;
          }

        </style>

    </head>
    <body style="font-size: 1.5rem">

        <table id="tabla-turnos-siendo-atendidos" class="table">
            <thead>
              <tr>
                <th scope="col" class="table-danger">Atendiendo</th>
                <th scope="col" class="table-danger">Destino</th>
                
              </tr>
            </thead>

            <tbody class="table-body">     
                
            </tbody>
            
        </table>

        <table id="tabla-turnos-en-espera" class="table">
            <thead>
              <tr>
                <th scope="col" class="table-primary">En espera</th>
                <th scope="col" class="table-primary">Destino</th>
                
              </tr>
            </thead>

            <tbody class="table-body">     
            
            </tbody>

        </table>

        <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-turno-llamada">
          Launch static backdrop modal
        </button> -->

        <div class="modal fade modal-success" id="modal-turno-llamada" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl" >
            <div class="modal-content">
              <!-- <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Modal title</h5>
              </div> -->
              <div class="modal-body">
                
                  <span>Turno </span>
                  <h1 class="codigo-turno-llamado"></h1>
                  <span>a departamento</span>
                  <h2 class="departamento-turno-llamado"></h2>
                  <span>división</span>
                  <h3 class="division-turno-llamado"></h3>
                
              </div>
            
            </div>
          </div>

          <audio id="audio-notificacion" class="my_audio" preload="none">
            <source src="{% static '/notificacion.mp3' %}" type="audio/mpeg">
            <source src="{% static '/notificacion.ogg' %}" type="audio/ogg">
          </audio>
      
        
        
        <script src="{% static '/jquery-3.6.0.js' %}"></script>
        <script src="{% static '/popper.min.js' %}"></script>
        <script src="{% static '/bootstrap-5.1.3-dist/js/bootstrap.js' %}"></script>
        <!-- <script src="{% static '/turnos.js' %}"></script> -->

        <script>
          let myModal = new bootstrap.Modal(document.getElementById('modal-turno-llamada'), {
            show: false
          })

                   

          const ws = new WebSocket(
              'ws://'
              + window.location.host
              + '/turnos/'

          );

          ws.onopen = function (e) {

              // setInterval(() => {
              //     ws.send("Compartiendo datos")
              // }, 1000);
              
              ws.send("Compartiendo datos")

              
              

              

          };

          let turnosSiendoAtendidos = []
          let turnosEnEspera = []

          ws.onmessage = function (e) {
              const data = JSON.parse(e.data);
              myModal.hide() //cerrar modal si esta abierto

              if(data.turnos_en_espera)
              for (let turno_en_espera of data.turnos_en_espera) {
                  if(turnosEnEspera.includes(turno_en_espera)){
                      
                  } else {
                      let tr = document.createElement('tr')
                      let tdCodigo = document.createElement('td')
                      let tdDestino =  document.createElement('td')
                      
                      tdCodigo.append(turno_en_espera.codigo)
                      tdDestino.append(turno_en_espera.departamento_servicio + ' : ' + turno_en_espera.division_departamento_servicio)
                      tdCodigo.classList.add('codigo')
                      tdDestino.classList.add('table-primary')

                      tr.appendChild(tdCodigo)
                      tr.appendChild(tdDestino)
                      tr.id = turno_en_espera.codigo

                      document.getElementById('tabla-turnos-en-espera').querySelector('.table-body').appendChild(tr)

                      turnosEnEspera.push(turno_en_espera)

                  }
                  
                  
              }
              

              if(data.turnos_siendo_atendidos)
              for (let turno_siendo_atendido of data.turnos_siendo_atendidos) {
                  if(turnosSiendoAtendidos.includes(turno_siendo_atendido)){
                    break;
                  }

                  if(turnosSiendoAtendidos.includes(turno_siendo_atendido)){

                  } else {

                      for(let turno_en_espera of turnosEnEspera){
                          if(turno_siendo_atendido.codigo == turno_en_espera.codigo){
                              document.getElementById(turno_en_espera.codigo).remove(); // esta instruccion siempre debe ir en este lugar para evitar borrar el elemento con el mismo id que es el codigo
                              indiceABorrar = turnosEnEspera.indexOf(turno_en_espera);
                              turnosEnEspera.splice(indiceABorrar, 1);
                              break;
                          }
                      }

                      for(let turno_siendo_atendido_i of turnosSiendoAtendidos){
                          if(turno_siendo_atendido.codigo == turno_siendo_atendido_i.codigo){
                              document.getElementById(turno_siendo_atendido_i.codigo).remove(); // esta instruccion siempre debe ir en este lugar para evitar borrar el elemento con el mismo id que es el codigo
                              indiceABorrar = turnosEnEspera.indexOf(turno_siendo_atendido_i);
                              turnosEnEspera.splice(indiceABorrar, 1);
                              break;
                          }
                      }

                      let tr = document.createElement('tr')
                      let tdCodigo = document.createElement('td')
                      let tdDestino =  document.createElement('td')
                      
                      tdCodigo.append(turno_siendo_atendido.codigo)
                      tdDestino.append(turno_siendo_atendido.departamento_servicio + ' : ' + turno_siendo_atendido.division_departamento_servicio)
                      tdCodigo.classList.add('codigo')
                      tdDestino.classList.add('table-danger')

                      tr.appendChild(tdCodigo)
                      tr.appendChild(tdDestino)
                      tr.id = turno_siendo_atendido.codigo

                      document.getElementById('tabla-turnos-siendo-atendidos').querySelector('.table-body').appendChild(tr)

                      turnosSiendoAtendidos.push(turno_siendo_atendido)
                      

                    
                      document.querySelector('.codigo-turno-llamado').textContent = turno_siendo_atendido.codigo
                      document.querySelector('.departamento-turno-llamado').textContent = turno_siendo_atendido.departamento_servicio
                      document.querySelector('.division-turno-llamado').textContent = turno_siendo_atendido.division_departamento_servicio
                      
                      myModal.show(1000)

                      let audio = document.getElementById('audio-notificacion')

                      audio.play();
                      
                      let utterance = new SpeechSynthesisUtterance();
                      utterance.voice = speechSynthesis.getVoices()[1]; //voz de google en español
                      utterance.lang = 'es-MX'
                      
             
                      utterance.text = `Turno ${turno_siendo_atendido.codigo} a departamento ${turno_siendo_atendido.departamento_servicio} y división ${textContent = turno_siendo_atendido.division_departamento_servicio}`;
                      

                      setTimeout(() => {
                        utterance.rate = 0.7; //texto
                        utterance.text = 'Turno'
                        speechSynthesis.speak(utterance);

                        setTimeout(() => {
                          utterance.rate = 0.4; //codigo
                          utterance.text = turno_siendo_atendido.codigo
                          speechSynthesis.speak(utterance);
                          
                        }, 700); // tiempo en el cual se menciona el codigo del turno.... este es el segundo 2

                        setTimeout(() => {
                          utterance.rate = 0.7; //texto
                          utterance.text = `a departamento ${turno_siendo_atendido.departamento_servicio} y división ${turno_siendo_atendido.division_departamento_servicio}`
                          speechSynthesis.speak(utterance);
                        }, 4000); //tiempo en que se lee lo que falta del texto .... este es el segundo 6
                        
                      }, 2500); //tiempo de espera antes de leer el texto para que no choque con el sonido de notificacion

                      setTimeout(() => {
                        myModal.hide()
                        
                      }, 12000);


                  }
                  
                  
              }

              if(data.turnos_atendidos)
              for (let turno_atendido of data.turnos_atendidos) {
                  for(let turno_siendo_atendido of turnosSiendoAtendidos){
                      if(turno_siendo_atendido.codigo == turno_atendido.codigo){
                          document.getElementById(turno_siendo_atendido.codigo).remove(); 
                          indiceABorrar = turnosSiendoAtendidos.indexOf(turno_siendo_atendido);
                          turnosSiendoAtendidos.splice(indiceABorrar, 1);
                          break;
                      }
                  }

              }

              if(data.turnos_descartados)
              for (let turno_descartado of data.turnos_descartados) {
                  for(let turno_siendo_atendido of turnosSiendoAtendidos){
                      if(turno_siendo_atendido.codigo == turno_descartado.codigo){
                          document.getElementById(turno_siendo_atendido.codigo).remove(); 
                          indiceABorrar = turnosSiendoAtendidos.indexOf(turno_siendo_atendido);
                          turnosSiendoAtendidos.splice(indiceABorrar, 1);
                          break;
                      }
                  }

                  for(let turno_en_espera of turnosEnEspera){
                  if(turno_siendo_atendido.codigo == turno_en_espera.codigo){
                      document.getElementById(turno_en_espera.codigo).remove();
                      indiceABorrar = turnosEnEspera.indexOf(turno_en_espera);
                      turnosEnEspera.splice(indiceABorrar, 1);
                      break;
                  }
              }

              }
              
              
          };



          ws.onclose = function (e) {
              console.error('El websocket cerró inesperadamente.');
          };
        </script>

        

        

    </body>
</html>
