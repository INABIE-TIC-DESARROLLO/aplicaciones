<!DOCTYPE html>
<html lang="en">
    <head>
        {% load static %}
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>INABIE - Turnos</title>
        {% comment %} <link rel="stylesheet" href="{% static '/turnos.css' %}"> {% endcomment %}
        <link rel="icon" href="{% static 'imagenes/logo.jpg' %}">
        <link rel="stylesheet" href="{% static '/bootstrap-5.1.3-dist/css/bootstrap.css' %}">

        <style>
          body{
              display: flex;
              justify-content: center;
              flex-wrap: wrap;
              flex-direction: row;

              

          }


          .titulo-atendiendo{
            text-align: center;
            margin: 0 auto;
            background-color: #1f3c73;
            color: aliceblue;
            border-radius: 1rem;
          }

          .titulo-en-espera{
            text-align: center;
            margin: 0 auto;
            background-color: goldenrod;
            color: rgb(87, 66, 14);
            border-radius: 1rem;
          }

          
          .badge.bg-warning{
            color: rgb(87, 66, 14);
          }

          @keyframes cambio-a-atendiendo {
            0% {
              transform: scale(1);
              color: white;
            }

            50%{
              transform: scale(1.2);
              color: #002c5e;
            }

            100%{
              transform: scale(1);
              color: white;
            }

          }

          .animacion-atendiendo{
            transform: scale(1);
            animation: cambio-a-atendiendo 2s linear 10s 5 alternate;
          }

          .badge{
            font-size: 1.5vw;
            font-weight: 800;
            margin: 1rem;
            
          }

          .turnos-en-espera .badge, .turnos-siendo-atendidos .badge{
            width: 25%;

          }


          .codigo{
              color: #002c5e;
              font-weight: 800;
          }

          .modal-body{
            
            background: linear-gradient(to right bottom, rgb(233, 232, 232), rgb(245, 245, 245), rgb(202, 202, 202));
            color: #086bdb;
            text-align: center;
          }

          .modal-body .codigo-turno-llamado{
            font-size: 10rem;
            color: #002c5e;
          }

          .modal-body span{
            font-size: 3rem;
          }

          .modal-body h2, h3, h4{
            font-size: 4rem;
            color: #002c5e;

          }

          .leyenda{
            width: 95%;
            margin: 1.5rem auto;
            display: grid;
            justify-content: center;
            justify-items: center;
            grid-template: 1fr / 1fr 1fr;
            border: 1px solid #ccdff5;
            border-radius: .5rem;
            box-shadow: -5px 5px 10px #ccdff5;
            padding: 1rem;

          }

          .leyenda h1{
            margin: 0 1rem;
            color: #002c5e;

          }

          .turnos-container{
            width: 95%;
            display: grid;
            grid-template: 1fr / 1fr 1fr;
            justify-content: center;
            justify-items: center;
            
          }

          .linea-divisora-vertical{
            height: 100%;
            margin: 0;
            border: 5px solid #002c5e;
            border-radius: 1rem;
          }

          .turnos-en-espera, .turnos-siendo-atendidos{
            width: 95%;
            min-height: 5000px;
            border: 1px solid #ccdff5;
            border-radius: 1rem;
            background-color: rgb(248, 248, 248);
            box-shadow: 5px 5px 10px #a3b9d1;

          }

          #logo-header{
            width: 7%;
            position: absolute;
            top: 2%;
            left: 50%;
            transform: translateX(-50%);

          }


        </style>

    </head>
    <body>

        <img src="{% static 'imagenes/logo.jpg' %}" alt="Logo INABIE" id="logo-header">

        <div class="leyenda">        
          <h1>Turnos <span class="badge bg-warning"><strong>EN ESPERA</strong></span></h1>
          <h1>Turnos <span class="badge bg-success"><strong>SIENDO ATENDIDOS</strong></span></h1>
        </div>

        <div class="turnos-container" id="turnos-container">

          <div class="turnos-en-espera" id="turnos-en-espera">
            {% for turno in turnos_en_espera %}
              <span class="badge bg-warning" id="en-espera-{{turno.codigo}}">{{turno.codigo}}</span>
            {% endfor %}
          </div>

          <!-- <div class="linea-divisora-vertical"></div> -->
          
          <div class="turnos-siendo-atendidos" id="turnos-siendo-atendidos">
            {% for turno in turnos_siendo_atendidos %}
              <span class="badge bg-success" id="atendiendo-{{turno.codigo}}">{{turno.codigo}}</span>
            {% endfor %}
          </div>

        </div>

       

        <div class="modal fade modal-success" id="modal-turno-llamada" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl" >
            <div class="modal-content">
              <!-- <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Modal title</h5>
              </div> -->
              <div class="modal-body">
                
                  <span>Turno </span>
                  <h1 class="codigo-turno-llamado"></h1>
                  <span>a dirección</span>
                  <h2 class="direccion-turno-llamado"></h2>
                  <span>departamento</span>
                  <h3 class="departamento-turno-llamado"></h3>
                  <span>división</span>
                  <h4 class="division-turno-llamado"></h4>
                
              </div>
            
            </div>
          </div>

          <audio id="audio-notificacion" class="my_audio" preload="none">
            <source src="{% static '/notificacion.mp3' %}" type="audio/mpeg">
            <source src="{% static '/notificacion.ogg' %}" type="audio/ogg">
          </audio>
      
        
        
        <script src="{% static '/jquery-3.6.0.js' %}"></script>
        <script src="{% static '/popper.min.js' %}"></script>
        <script src="{% static '/bootstrap-5.1.3-dist/js/bootstrap.js' %}"></script>
        <!-- <script src="{% static '/turnos.js' %}"></script> -->

        {{ piso|json_script:"numero-piso" }}

        <script>

          const piso = JSON.parse(document.getElementById('numero-piso').textContent);


          let myModal = new bootstrap.Modal(document.getElementById('modal-turno-llamada'), {
            show: false
          })

                   

          const ws = new WebSocket(
              'ws://'
              + window.location.host
              + '/turnos/'

          );

          ws.onopen = function (e) {


          };

          let turnosSiendoAtendidos = []
          let turnosEnEspera = []

          ws.onmessage = function (e) {
              const data = JSON.parse(e.data);
              myModal.hide() //cerrar modal si esta abierto

              if(data.turnos_en_espera)
              for (let turno_en_espera of data.turnos_en_espera) {

                  if(turno_en_espera.piso_turno == piso)
                  if(turnosEnEspera.includes(turno_en_espera) || document.querySelector(`#turnos-container #turnos-en-espera #en-espera-${turno_en_espera.codigo}`)){
                      
                  } else {
                      let badge = document.createElement('span')
                                            
                      badge.textContent = turno_en_espera.codigo
                      badge.classList.add('badge', 'bg-warning')
                      badge.id = turno_en_espera.codigo

                      document.getElementById('turnos-en-espera').appendChild(badge)

                      turnosEnEspera.push(turno_en_espera)

                  }
                  
                  
              }
              

              if(data.turnos_siendo_atendidos)
              for (let turno_siendo_atendido of data.turnos_siendo_atendidos) {

                  if(turno_siendo_atendido.piso_turno == piso)
                  if(turnosSiendoAtendidos.includes(turno_siendo_atendido) || document.querySelector(`#turnos-container #turnos-siendo-atendidos #atendiendo-${turno_siendo_atendido.codigo}`)){

                  } else {

                      for(let turno_en_espera of turnosEnEspera){
                          if(turno_siendo_atendido.codigo == turno_en_espera.codigo){
                              document.getElementById(turno_en_espera.codigo).remove(); // esta instruccion siempre debe ir en este lugar para evitar borrar el elemento con el mismo id que es el codigo
                              indiceABorrar = turnosEnEspera.indexOf(turno_en_espera);
                              turnosEnEspera.splice(indiceABorrar, 1);
                              break;
                          }

                          if(document.querySelector(`#turnos-container #turnos-en-espera #en-espera-${turno_siendo_atendido.codigo}`)) //para borrar el turno si no fue cargado por el websocket, es decir, fue cargado al renderizar el html
                          document.querySelector(`#turnos-container #turnos-en-espera #en-espera-${turno_siendo_atendido.codigo}`).remove();
                      }

                      for(let turno_siendo_atendido_i of turnosSiendoAtendidos){
                          if(turno_siendo_atendido.codigo == turno_siendo_atendido_i.codigo){
                              document.getElementById(turno_siendo_atendido_i.codigo).remove(); // esta instruccion siempre debe ir en este lugar para evitar borrar el elemento con el mismo id que es el codigo
                              indiceABorrar = turnosEnEspera.indexOf(turno_siendo_atendido_i);
                              turnosEnEspera.splice(indiceABorrar, 1);
                              break;
                          }
                      }

                      let badge = document.createElement('span')
                                            
                      badge.textContent = turno_siendo_atendido.codigo
                      badge.classList.add('badge', 'bg-success', 'animacion-atendiendo')
                      badge.id = turno_siendo_atendido.codigo

                      document.getElementById('turnos-siendo-atendidos').appendChild(badge)

                      turnosSiendoAtendidos.push(turno_siendo_atendido)
                      

                    
                      document.querySelector('.codigo-turno-llamado').textContent = turno_siendo_atendido.codigo
                      document.querySelector('.direccion-turno-llamado').textContent = turno_siendo_atendido.direccion_servicio

                      if(turno_siendo_atendido.division_departamento_servicio && turno_siendo_atendido.departamento_servicio){
                        document.querySelector('.departamento-turno-llamado').textContent = turno_siendo_atendido.departamento_servicio
                        document.querySelector('.division-turno-llamado').textContent = turno_siendo_atendido.division_departamento_servicio
                      } else if (turno_siendo_atendido.division_departamento_servicio) {
                        document.querySelector('.departamento-turno-llamado').textContent = "N/A"
                        document.querySelector('.division-turno-llamado').textContent = turno_siendo_atendido.division_departamento_servicio
                      } else { // el turno solo tiene direccion y departamento
                        document.querySelector('.departamento-turno-llamado').textContent = turno_siendo_atendido.departamento_servicio
                        document.querySelector('.division-turno-llamado').textContent = "N/A"
                      }
                      
                      
                      
                      myModal.show(1000)

                      let audio = document.getElementById('audio-notificacion')

                      audio.play();
                      
                      let utterance = new SpeechSynthesisUtterance();
                      utterance.voice = speechSynthesis.getVoices()[1]; //voz de google en español
                      utterance.lang = 'es-MX'
                                  
                      // utterance.text = `Turno ${turno_siendo_atendido.codigo} a departamento ${turno_siendo_atendido.departamento_servicio} y división ${textContent = turno_siendo_atendido.division_departamento_servicio}`;
                      
                      setTimeout(() => {
                        utterance.rate = 0.9; //texto
                        utterance.text = 'Turno'
                        speechSynthesis.speak(utterance);

                        setTimeout(() => {
                          utterance.rate = 0.68; //codigo
                          utterance.text = turno_siendo_atendido.codigo
                          speechSynthesis.speak(utterance);
                          
                        }, 700); // tiempo en el cual se menciona el codigo del turno.... este es el segundo 2

                        setTimeout(() => {
                          utterance.rate = 0.95; //texto

                          if(turno_siendo_atendido.division_departamento_servicio && turno_siendo_atendido.departamento_servicio){
                            utterance.text = `a departamento ${turno_siendo_atendido.departamento_servicio} y división ${turno_siendo_atendido.division_departamento_servicio}`
                          } else if (turno_siendo_atendido.division_departamento_servicio) {
                            utterance.text = `a dirección ${turno_siendo_atendido.direccion_servicio} y división ${turno_siendo_atendido.division_departamento_servicio}`
                          } else { // el turno solo tiene direccion y departamento
                            utterance.text = `a dirección ${turno_siendo_atendido.direccion_servicio} y departamento ${turno_siendo_atendido.departamento_servicio}`
                          }
                          
                          speechSynthesis.speak(utterance);
                        }, 4000); //tiempo en que se lee lo que falta del texto .... este es el segundo 6
                        
                      }, 2500); //tiempo de espera antes de leer el texto para que no choque con el sonido de notificacion

                      setTimeout(() => {
                        myModal.hide() //esconder el modal
                        
                      }, 12000);


                  }
                  
                  
              }

              if(data.turnos_atendidos)
              for (let turno_atendido of data.turnos_atendidos) {
                  for(let turno_siendo_atendido of turnosSiendoAtendidos){
                      if(turno_siendo_atendido.codigo == turno_atendido.codigo){
                          document.getElementById(turno_siendo_atendido.codigo).remove(); 
                          indiceABorrar = turnosSiendoAtendidos.indexOf(turno_siendo_atendido);
                          turnosSiendoAtendidos.splice(indiceABorrar, 1);
                          break;
                      }
                  }

                  if(document.querySelector(`#turnos-container #turnos-siendo-atendidos #atendiendo-${turno_atendido.codigo}`)) //para borrar el turno si no fue cargado por el websocket, es decir, fue cargado al renderizar el html
                  document.querySelector(`#turnos-container #turnos-siendo-atendidos #atendiendo-${turno_atendido.codigo}`).remove();

              }

              if(data.turnos_descartados)
              for (let turno_descartado of data.turnos_descartados) {
                  for(let turno_siendo_atendido of turnosSiendoAtendidos){
                      if(turno_siendo_atendido.codigo == turno_descartado.codigo){
                          document.getElementById(turno_siendo_atendido.codigo).remove(); 
                          indiceABorrar = turnosSiendoAtendidos.indexOf(turno_siendo_atendido);
                          turnosSiendoAtendidos.splice(indiceABorrar, 1);
                          break;
                      }
                  }

                  for(let turno_en_espera of turnosEnEspera){
                  if(turno_siendo_atendido.codigo == turno_en_espera.codigo){
                      document.getElementById(turno_en_espera.codigo).remove();
                      indiceABorrar = turnosEnEspera.indexOf(turno_en_espera);
                      turnosEnEspera.splice(indiceABorrar, 1);
                      break;
                  }
                
                  if(document.querySelector(`#turnos-container #turnos-en-espera #en-espera-${turno_descartado.codigo}`)) //para borrar el turno si no fue cargado por el websocket, es cedir, fue cargado al renderizar el html
                  document.querySelector(`#turnos-container  #turnos-en-espera #en-espera-${turno_descartado.codigo}`).remove();

                  if(document.querySelector(`#turnos-container #turnos-siendo-atendidos #atendiendo-${turno_descartado.codigo}`)) //para borrar el turno si no fue cargado por el websocket, es cedir, fue cargado al renderizar el html
                  document.querySelector(`#turnos-container #turnos-siendo-atendidos #atendiendo-${turno_descartado.codigo}`).remove();
              }

              }
              
              
          };



          ws.onclose = function (e) {
              console.error('El websocket cerró inesperadamente.');
          };
        </script>

        

        

    </body>
</html>
