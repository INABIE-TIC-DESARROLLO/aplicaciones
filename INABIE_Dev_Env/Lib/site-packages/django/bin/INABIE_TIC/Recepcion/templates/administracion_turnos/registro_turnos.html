<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración Turnos - Recepción</title>
    <link rel="stylesheet" href="{% static '/bootstrap-5.1.3-dist/css/bootstrap.css' %}">
    <link rel="icon" href="{% static 'imagenes/logo.jpg' %}">
    <script src="https://kit.fontawesome.com/c47026966a.js" crossorigin="anonymous"></script>
    <style>
        body{
            background: #f5f4f4;
            /* background: linear-gradient(to right, #d9112830, #3283f57d); */
            background: linear-gradient(to right, #206eda90, #c80c0c3c);

            font-size: 1.25rem;

        }
        h2{
            color: #0548ad;
        }

        .enlaces{
            color: #0548ad;
        }
        .h2-color{
            color: white;
        }
        .tamaño-titulo{
            /* background-color: rgb(34, 39, 195); */
            font-size: 27px;
        }
        .btn-enviar{
            background-color:#0548ad;
            color: #ffffff;
        }
        .margin-left{
            margin-left: 2rem;
        }
        .letra-blancas{
            color: white;
        }

        .form-container{
            height: fit-content;
        }

        #nav-fecha{
            color: #0548ad;
            font-size: 1.5rem;
            font-weight: 600;
        }




    </style>
</head>
<body>
    
    
    <nav class="navbar navbar-light bg-light mt-2 shadow">
        <div class="container">
        <a class="navbar-brand" href="#">
            <img src="{% static './imagenes/LOGO-MOSCA-02.png' %}" width="" alt="" height="80">
        </a>
        <h2>INABIE - Gestión de turnos en recepción</h2>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
            
            <div class="enlaces collapse navbar-collapse">
                <div class="navbar-nav enlaces">
                <a class="nav-link active" aria-current="page" href="#">Bienvenido/a, <b>{{user.username}}</b></a>
                <a class="nav-link active mx-3" id="nav-fecha" aria-current="page" href="#">{{fecha}}</a>
    
                </div>
            </div>
            </div>
        </nav>
        </div>
    </nav>

    {% if mensaje_retroalimentacion  %}
        <div class="toast position-absolute start-50 translate-middle-x align-items-center text-light bg-success border-0 show my-2 mx-auto" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
            <div class="toast-body">
                {{mensaje_retroalimentacion}}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    {% endif %}


    <div class="container">
        <div class="row">
            <div class="col-7 rounded bg-white p-5 mt-2 shadow form-container">
                
                <form action="" method="post" class="row g-3 was-validated" id="nuevo-turno-form">
                    {% csrf_token %}

                    <div class="col-12">
                        <h2>Registro de turnos</h2>
                    </div>

                    <div class="row my-2">
                        <div class="col">
                            <label for="cedula_persona_atendida" class="form-label">Cédula Persona Rebidora del Servicio:</label>
                            <input type="text" class="form-control" list="personas" name="cedula_persona_atendida" id="cedula_persona_atendida" placeholder="Ingrese cedula o nombre..." maxlength="11" required>
                            
                        </div>
                        <div class="col">
                            <label for="cedula_representante_turno" class="form-label">Cédula Representante del turno:</label>
                            <input type="text" class="form-control" list="personas" name="cedula_representante_turno" id="cedula_representante_turno" placeholder="Ingrese cedula o nombre..." maxlength="11">
                            
                        </div>
                        <div class="col-auto">
                        
                            <button class="btn btn-primary mt-4" data-bs-toggle="modal" data-bs-target="#agregar-nueva-persona-modal">Añadir nueva persona</button>
                        </div>
                        

                    </div>
                    

                    <!-- Lista de personas atendidas -->
                    <datalist id="personas">
                        {% for persona in personas_atendidas %}
                            <option value="{{persona.cedula_rnc}}">{{persona.nombre}}</option>
                        {% endfor %}
                    </datalist>

                    
                    
                    <div class="col-12">
                        <label for="motivo" class="form-label">Motivo de solicitud de servicio:</label>
                        <textarea name="motivo" id="motivo" cols="10" rows="2" class="form-control" required></textarea>
                    </div>
                    <div class="col-12">
                        <label for="direccion" class="form-label">Dirección:</label>
                        <select class="form-select" aria-label="Direcciones" name="direccion" id="direccion" placeholder="Nombre de la direccion" required>
                            <option></option>
                            {% for direccion in direcciones %}
                                <option value="{{direccion.nombre}}">{{direccion.nombre}}</option>
                            {% endfor %}
                        </select>
                        
                    </div>
                    <div class="row my-2">
                        <div class="col">
                            <label for="departamento" class="form-label">Departamento u Oficina:</label>
                            <select class="form-select" aria-label="Departamentos" name="departamento" id="departamento-select" placeholder="Nombre del departamento" required>
                                <option></option>
                            </select>
                            
                        </div>
                        <div class="col">
                            <label for="division" class="form-label">División o Sección:</label>
                            <select class="form-select" aria-label="Divisiones" name="division" id="division-select" placeholder="Nombre de la division" required>
                                <option></option>
                            </select>
                        </div>
                    </div>
                    <div class=" form-check p-2">
                        <div class="col-3 form-check form-check-inline ">
                            <label class="" for="preferencial">Preferencial</label>
                            <input class="form-check-input" type="checkbox" name="preferencial" id="preferencial">
                            
                        </div>
                        <small class="d-block text-info fw-bold">Personas con discapacidad, embarazadas, envejecientes, entre otros...</small>
                    </div>
                    <div class="col-12">
                        <label for="comentario" class="form-label ">Comentario:</label>
                        <textarea name="comentario" id="comentario" cols="10" rows="2" class="form-control" maxlength="300"></textarea>
                    </div>
                    <div class="col-12 mt-4 ml-5">
                        <input type="submit" class="btn btn-primary btn-enviar" value="Guardar" id="guardarForm">
                    </div>


                    
                </form>
            </div>

            <!-- Modal Añadir Persona Nueva-->
            <div class="modal fade" id="agregar-nueva-persona-modal" tabindex="-1" aria-labelledby="añadirModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="añadirModalLabel">Añadiendo Nueva Persona</h3>
                        <button type="submit" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form action="" method="post" class="form-control row g-3 needs-validation was-validated" id="nueva-persona-form" >
                            {% csrf_token %}
                            <div class="col-12">
                                <label for="cedula_rnc" class="control-label">Cedula o RNC:</label>
                                <input type="text" class="form-control" name="cedula_rnc" id="cedula_rnc_nueva_persona" minlength="9" maxlength="11" required>
                            </div>
                            <div class="col-12">
                                <label for="nombre" class="control-label">Nombre:</label>
                                <input type="text" class="form-control" name="nombre" id="nombre_nueva_persona" required>
                            </div>
                            <div class="col-12">
                                <label for="relacion_con_inabie" class="control-label">Relacion con el INABIE:</label>
                                <select class="form-select" name="relacion_con_inabie" id="relacion_con_inabie_nueva_persona" required>
                                    <option value="OFERENTE/PROVEEDOR">OFERENTE/PROVEEDOR</option>
                                    <option value="PADRE/TUTOR DE ESTUDIANTE">PADRE/TUTOR DE ESTUDIANTE</option>
                                    <option value="VISITANTE">VISITANTE</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="tipo_persona" class="control-label">Tipo de persona:</label>
                                <select class="form-select" name="tipo_persona" id="tipo_persona_nueva_persona" required>
                                    <option value="FISICA">FISICA</option>
                                    <option value="JURIDICA">JURIDICA</option>
                                    <option value="VISITANTE">VISITANTE</option>
                                </select>
                                
                            </div>
                            <div class="col-12">
                                <label for="telefono" class="control-label">Telefono:</label>
                                <input type="text" class="form-control" name="telefono" id="telefono_nueva_persona" minlength="10" maxlength="10" required>
                            </div>



                                
                            <input type="submit" class="btn btn-primary mt-4" value="Guardar" name="agregar-nueva-persona">
                            <button class="btn btn-danger mt-2" data-bs-dismiss="modal">Cerrar</button>

                        </form>

                        
                    </div>
                    
                    </div>
                </div>
            </div>

            <!-- Columna turnos guardados -->
            <div class="col-4 rounded bg-white p-4 mt-2 shadow margin-left" id="turnos-registrados">
                <h2 class="h2-margin my-3">Turnos registrados hoy</h2>
                <h3 class="my-3 fs-4">En espera: <span class="text-warning">{{turnos_en_espera|length}}</span></h3>
                <h4 class="my-3 fs-4">Siendo atendidos: <span class="text-success">{{turnos_siendo_atendidos|length}}</span></h4>
                <h5 class="my-3 fs-4">Atendidos: <span class="text-info">{{turnos_atendidos|length}}</span></h5>
                <h6 class="my-3 fs-4">Total: <span class="text-primary">{{turnos_de_hoy|length}}</span></h6>

                <label for="exampleDataList" class="form-label">Buscar turno</label>
                <input class="form-control" list="turnos-datalist" id="turno-a-buscar" placeholder="Nombre de la persona atendida">
                <datalist id="turnos-datalist">               
                    {% for turno in turnos_de_hoy %}
                        <option value="{{turno.persona_atendida.nombre}}">
                    {% endfor %}
                </datalist>

                {% for turno in turnos_de_hoy %}
                    <div class="card my-5 bg-light" id="{{turno.codigo}}">
                        <div class="card-body">
                            <h4 class="card-title" id="turno-buscado-codigo">Código: <strong class="text-primary">{{turno.codigo}}</strong></h4>
                            <h5 class="card-title" id="turno-buscado-nombre-persona">Recibe el servicio: <strong>{{turno.persona_atendida.nombre}}</strong></h5>
                            <h6 class="card-title" id="turno-buscado-nombre-persona">Representa el turno: <strong>{{turno.persona_representante_turno.nombre}}</strong></h6>
                            <p class="card-text" id="turno-buscado-motivo">Motivo: <strong>{{turno.motivo_solicitud_servicio}}</strong></p>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item" id="turno-buscado-departamento">Departamento: <strong>{{turno.departamento_servicio}}</strong></li>
                            <li class="list-group-item" id="turno-buscado-division">División: <strong>{{turno.division_departamento_servicio}}</strong></li>
                            <li class="list-group-item" id="turno-buscado-hora-registro">Hora Registro: <strong>{{turno.hora_registro}}</strong></li>
                            
                            {% if  turno.preferencial %}
                                <li class="list-group-item" id="turno-buscado-preferencial">Preferencial: SI</li>
                            {% else %}
                                <li class="list-group-item" id="turno-buscado-preferencial">Preferencial: NO</li>
                            {% endif %}
                            
                            {% if turno.estado == 'EN ESPERA' %}
                                <li class="list-group-item" id="turno-buscado-estado">Estado: <strong class="text-warning">{{turno.estado}}</strong></li>
                            {% elif turno.estado == 'ATENDIENDO'%}
                                <li class="list-group-item" id="turno-buscado-estado">Estado: <strong class="text-success">{{turno.estado}}</strong></li>
                            {% else%}
                                <li class="list-group-item" id="turno-buscado-estado">Estado: <strong class="text-dark">{{turno.estado}}</strong></li>
                            {% endif %}

                            {% if turno.comentarios %}
                                <li class="list-group-item" id="turno-buscado-comentario">Comentario: {{turno.comentarios}}</li>
                            {% endif %}
                            
                        </ul>
                        
                    </div>
                        
                {% endfor %}

                


                
                
            </div>

    </div>

    {{ direcciones|json_script:"direcciones-json" }}
    {{ departamentos |json_script:"departamentos-json" }} <!-- primero el valor que viene desde el request y luego el valor de id que va a javascript-->
    {{ divisiones|json_script:"divisiones-json" }}
    

    {{ turnos_de_hoy_json|json_script:"turnos-de-hoy-json" }}

    <script src="{% static '/jquery-3.6.0.js' %}"></script>
    <script src="{% static '/popper.min.js' %}"></script>
    <script src="{% static '/bootstrap-5.1.3-dist/js/bootstrap.js' %}"></script>

    <script>

        const ws = new WebSocket('ws://' + window.location.host + '/turnos/'); //para conectarse al WS y que no muestre error al guardar algun turno

        const nuevo_turno_form = document.getElementById('nuevo-turno-form')
        const direcciones  = JSON.parse(document.getElementById('direcciones-json').textContent);
        const departamentos  = JSON.parse(document.getElementById('departamentos-json').textContent);
        const divisiones  = JSON.parse(document.getElementById('divisiones-json').textContent);
        

        // const departamentos_datalist = document.getElementById('departamentos-datalist')
        const divisiones_select = document.getElementById('division-select')
        const departamentos_select = document.getElementById('departamento-select')

        const direccion_input = document.getElementById('direccion')


        direccion_input.addEventListener('input', () => {

            while (departamentos_select.hasChildNodes()) {
                departamentos_select.firstChild.remove();
            }

            while (divisiones_select.hasChildNodes()) {
                divisiones_select.firstChild.remove();
            }

            departamentos_select.textContent = ''
            divisiones_select.textContent = ''

            let direccion = direcciones.find(direccion => direccion.nombre == direccion_input.value)
            let id_direccion;

            if(direccion){
                id_direccion = direccion.pk_id //id del dapartamento seleccionado en el input

                //para agregar primera opcion en blanco
                let div = document.createElement('option')//division del departamento
                
                departamentos_select.appendChild(div)

                for(let departamento of departamentos ){
                    

                    if(departamento.direccion_perteneciente_id == id_direccion){
                        let div = document.createElement('option')//departamento del departamento
                        div.setAttribute('value', departamento.nombre)
                        div.textContent = departamento.nombre
                        departamentos_select.appendChild(div)
    
    
                    } 
                        
    
                }

                divisiones_select.appendChild(div)

                for(let division of divisiones ){

                    if(division.direccion_perteneciente_id == id_direccion){
                        let div = document.createElement('option')//division del departamento
                        div.setAttribute('value', division.nombre)
                        div.textContent = division.nombre
                        divisiones_select.appendChild(div)
    
    
                    } 
                        
    
                }

                //si el departamento no tiene divisiones entonces la division no es requerida en el formulario
                if(divisiones_select.hasChildNodes()){
                    divisiones_select.setAttribute('required', '');
                    divisiones_select.removeAttribute('disabled')
                } else {
                    divisiones_select.removeAttribute('required')
                    divisiones_select.setAttribute('disabled', '')
                }


                if(departamentos_select.hasChildNodes()){
                    departamentos_select.setAttribute('required', '');
                    departamentos_select.removeAttribute('disabled')
                } else {
                    departamentos_select.removeAttribute('required')
                    departamentos_select.setAttribute('disabled')
                }
            }

            departamentos_select.value = null //para obligar al usuario a elegir un departamento y que no ponga alguno por defecto

            


             
        });

        departamentos_select.addEventListener('input', () => {

            while (divisiones_select.hasChildNodes()) {
                divisiones_select.firstChild.remove();
            }

            divisiones_select.textContent = ''
            

            let departamento = departamentos.find(departamento => departamento.nombre == departamentos_select.value)
            let id_departamento;

            if(departamento){
                id_departamento = departamento.pk_id //id del dapartamento seleccionado en el input

                


                for(let division of divisiones ){
                    

                    if(division.departamento_perteneciente_id == id_departamento){
                        let div = document.createElement('option')//division del departamento
                        div.setAttribute('value', division.nombre)
                        div.textContent = division.nombre
                        divisiones_select.appendChild(div)
    
    
                    } 
                        
    
                }

                //si el departamento no tiene divisiones entonces la division no es requerida en el formulario
                if(divisiones_select.hasChildNodes()){
                    divisiones_select.setAttribute('required', '');
                    divisiones_select.removeAttribute('disabled')
                    //para agregar primera opcion en blanco
                    let div = document.createElement('option')//division del departamento
                    divisiones_select.appendChild(div)
                } else {
                    divisiones_select.removeAttribute('required')
                    divisiones_select.setAttribute('disabled', '')
                }
            }
             
        });

        divisiones_select.addEventListener('input', () => {

            // while (departamentos_select.hasChildNodes()) {
            //     departamentos_select.firstChild.remove();
            // }

            // departamentos_select.textContent = ''
            

            // let departamento = departamentos.find(departamento => departamento.nombre == departamentos_select.value)
            // let id_departamento;

            // if(departamento){
            //     id_departamento = departamento.pk_id //id del dapartamento seleccionado en el input

                for(let division of divisiones ){
                    

                    if(division.nombre == divisiones_select.value){
                        

                        if(division.departamento_perteneciente_id == null || division.departamento_perteneciente_id == ''){
                            departamentos_select.removeAttribute('required')
                            departamentos_select.value = ''
                        } else {

                            for(let departamento of departamentos){

                                if(departamento.pk_id == division.departamento_perteneciente_id){
                                    // departamentos_select.value = departamento.nombre

                                    break;
                                } else {
                                    departamentos_select.removeAttribute('required')
                                    
                                }
                                
                                
                            }
                            

                        }

                        break;

                    } 
                        
    
                }


            // }
             
        });

        setTimeout(() => {
            $('.toast').hide(1000)
        }, 7000);

        // mostrando el turno buscado

        const turno_a_buscar = document.getElementById('turno-a-buscar')
        const turnos_de_hoy_json = JSON.parse(document.getElementById('turnos-de-hoy-json').textContent);
        
        turno_a_buscar.addEventListener("input", () => {
            

            for(let turno of turnos_de_hoy_json){
                
                if(turno_a_buscar.value == turno.persona_atendida__nombre){
                    $(`#${turno.codigo}`).show(250)
                } else if(turno_a_buscar.value != turno.persona_atendida__nombre && turno_a_buscar.value.trim() != '' && turno_a_buscar.value != undefined ) {
                    $(`#${turno.codigo}`).hide(250)
                } else{
                    $(`#${turno.codigo}`).show(250)
                }

            }
        });
        
        
        nuevo_turno_form.addEventListener("submit", () =>{
            setTimeout(() => {
                window.location.reload();
            }, 1000);
           

        });

    </script>

</body>
</html>