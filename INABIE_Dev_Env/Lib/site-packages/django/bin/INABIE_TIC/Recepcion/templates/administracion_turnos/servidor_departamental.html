<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración Turnos - Departamento</title>
    <script src="https://kit.fontawesome.com/c47026966a.js" crossorigin="anonymous"></script>
    <link rel="icon" href="{% static 'imagenes/logo.jpg' %}">
    <link rel="stylesheet" href="{% static '/bootstrap-5.1.3-dist/css/bootstrap.css' %}">

    <style>
        body{
            background: #f5f4f4;
            /* background: linear-gradient(to right, #d9112830, #3283f57d); */
            background: linear-gradient(to right, #206eda90, #c80c0c3c);

        }

        .enlaces{
            color: #0548ad;
        }
        .h2-color{
            color: white;
        }

        .titulo-principal{
          background-color: #002C5F;
          color: aliceblue;
          padding: .5rem;
          border-radius: .5rem;
        }
        .tamaño-titulo{
            /* background-color: rgb(34, 39, 195); */
            font-size: 27px;
        }
        .btn-enviar{
            background-color:#0548ad;
            color: #ffffff;
        }
        .box{
            margin: 30px;
        }

        #nav-fecha{
          color: #0548ad;
          font-size: 1.5rem;
          font-weight: 600;
      }


    </style>
</head>
<body>
    
    
  <nav class="navbar navbar-light bg-light mt-2 shadow">
    <div class="container">
    <a class="navbar-brand" href="#">
        <img src="{% static './imagenes/LOGO-MOSCA-02.png' %}" width="" alt="" height="80">
    </a>
    <h2 class="">INABIE - Gestión de turnos departamental</h2>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
        
        <div class="enlaces collapse navbar-collapse">
            <div class="navbar-nav enlaces">
            <a class="nav-link active" aria-current="page" href="#">Bienvenido/a, <b>{{user.username}}</b></a>
            <a class="nav-link active mx-3" id="nav-fecha" aria-current="page" href="#">{{fecha}}</a>

            </div>
        </div>
        </div>
    </nav>
    </div>
  </nav>
    <!-- ************************ -->
    <!-- ** VENTANAS DE TURNOS ** -->
    <!-- ************************ -->

    <div class="box">
        <div class="row">
            <div class="col-sm-3">
              <div class="card shadow">
                <div class="card-body">
                    <h2 class="card-title text-center titulo-principal">Turnos preferenciales</h2>

                    <div id="turnos-preferenciales">
                      {% for turno in turnos_preferenciales %}
                        <div class="card text-center bg-light my-2" id="{{turno.codigo}}">
                        
                          <h5 class="card-title fs-3 text-warning mt-3"><b>{{turno.codigo}}</b></h5>
                          <p class="card-text fs-5">Recibe el servicio: <strong>{{turno.persona_atendida.nombre}}</strong></p>
                          <p class="card-text fs-5">Representa el turno: <strong>{{turno.persona_representante_turno.nombre}}</strong></p>
                          <p class="card-text fs-5 mb-3">Hora registro: {{turno.hora_registro}}</p>

                          {% if turno.comentarios %}
                            <p class="card-text fs-5">Comentario: {{turno.comentarios}}</p>
                          {% endif %}

                          
                          <form method="post" id="atender-turno-preferencial-form">
                            {% csrf_token %}
                            <input type="text" value="{{turno.codigo}}" class="d-none" id="codigo" name="codigo">
    
                              
                            <div class="card-footer text-muted">
                              {% if forloop.first %}
                                {% if turno_actual %}
                                  <input type="submit" class="btn btn-warning d-none" value="Atender" name="atender-turno" id="atender-turno-preferencial-submit-button">
                                {% else %}
                                  <input type="submit" class="btn btn-warning" value="Atender" name="atender-turno" id="atender-turno-preferencial-submit-button">
                                {% endif %}
                              {% endif %} 
                            </div>
                              
                              
      
                          </form>
                              
                          

                          

                        </div>
                    
                      {% endfor %}

                    </div>
                    

                </div>
              </div>
            </div>

            <div class="col-sm-6  fs-5">
                <div class="card shadow turno">
                  <div class="card-body ">
                    
                    <h1 class="card-title text-center titulo-principal fs-2">Turno Actual</h1>

                    {% if turno_actual %}
                    <div class="card text-center" id="turno-actual">
                      
                      <div class="card-body">
                        <h5 class="card-title fs-3 text-success"><b>{{turno_actual.codigo}}</b></h5>
                        <p class="card-text fs-5">Recibe el servicio: <strong>{{turno_actual.persona_atendida.nombre}}</strong></p>
                        <p class="card-text fs-5">Representa el turno: <strong>{{turno_actual.persona_representante_turno.nombre}}</strong></p>
                        <p class="card-text fs-5"><b>Comentario: </b>{{turno_actual.comentarios}}</p>
                      </div>

                      <form method="post">
                        {% csrf_token %}
                        <input type="text" value="{{turno_actual.codigo}}" class="d-none" id="codigo" name="codigo">

                        <div class="my-3 mx-auto w-75">
                          <label for="estado-solucion" class="form-label">Estado de la solución</label>
                          <select class="form-select" id="estado-solucion" name="estado-solucion" aria-label="Estado de la solucion" required>
                            <option selected value="INCOMPLETO">INCOMPLETO</option>
                            <option value="RESUELTO">RESUELTO</option>
                            <option value="NO RESUELTO">NO RESUELTO</option>
                          </select>
                        </div>

                        <div class="mb-3 mx-auto w-75">
                          <label for="comentario-departamental" class="form-label">Comentario</label>
                          <textarea class="form-control" id="comentario-departamental" name="comentario-departamental" rows="3" required maxlength="500" minlength="16"></textarea>
                        </div>

                        <div class="card-footer text-muted">

                          <input type="submit" class="btn btn-success" value="Finalizar" name="finalizar-turno" id="finalizar-turno">

                        </div>

                      </form>
                      
                    </div>

                    <h2 class="titulo-principal text-center my-3">Historico</h2>
                    
                      {% for turno in historico_turnos %}
                        <div class="card border-dark my-3">
                          <div class="card-header">
                            <div class="container text-center">
                              <div class="row">
                                <div class="col">
                                  <strong>Fecha: </strong> {{turno.fecha_registro|date:"d/m/Y"}}
                                </div>
                                <div class="col">
                                  <strong>Hora Registro: </strong> {{turno.hora_registro}}
                                </div>
                                <div class="col">

                                  {% if turno.estado_solucion == "INCOMPLETO" %}
                                    <strong>Conclusión: </strong> <span class="text-warning fw-bold">{{turno.estado_solucion}}</span>
                                  {% elif turno.estado_solucion == "NO RESUELTO" %}
                                    <strong>Conclusión: </strong> <span class="text-danger fw-bold">{{turno.estado_solucion}}</span>
                                  {% else %}
                                    <strong>Conclusión: </strong> <span class="text-success fw-bold">{{turno.estado_solucion}}</span>
                                  {% endif %}



                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="card-body">

                            <h5 class="card-title">Motivo</h5>
                            <p class="card-text">{{turno.motivo_solicitud_servicio}}</p>
                            <hr>
                            <h5 class="card-title">Comentario de la Conclusión</h5>
                            <p class="card-text">{{turno.comentario_departamental}}</p>
                          </div>
                        </div>
                      {% endfor %}


                    
                    {% endif %}
                  </div>
                </div>
            </div>

            <div class="col-sm-3">

              <div class="card shadow">
                <div class="card-body">
                  <h2 class="card-title text-center titulo-principal">Turnos siguientes</h2>
                  <div id="turnos-siguientes">

                    {% for turno in turnos %}
                      <div class="card text-center bg-light my-2" id="{{turno.codigo}}">
                      
                        <div class="card-body">
                          <h5 class="card-title fs-3 text-primary"><b>{{turno.codigo}}</b></h5>
                          <p class="card-text fs-5">Recibe el servicio: <strong>{{turno.persona_atendida.nombre}}</strong></p>
                          <p class="card-text fs-5">Representa el turno: <strong>{{turno.persona_representante_turno.nombre}}</strong></p>
                          <p class="card-text fs-5">Hora registro: {{turno.hora_registro}}</p>

                          {% if turno.comentarios %}
                            <p class="card-text fs-5">Comentario: {{turno.comentarios}}</p>
                          {% endif %}
                          
                          
                          
                          

                        </div>

                        
                        <form method="post" id="atender-turno-form">
                          {% csrf_token %}
                          <input type="text" value="{{turno.codigo}}" class="d-none" id="codigo" name="codigo">
  
                            
                          <div class="card-footer text-muted">
                            {% if forloop.first %}
                              {% if  turno_actual %}
                                <input type="submit" class="btn btn-primary d-none" value="Atender" name="atender-turno" id="atender-turno-submit-button">
                              {% else %}
                                <input type="submit" class="btn btn-primary" value="Atender" name="atender-turno" id="atender-turno-submit-button">
                              {% endif %}
                            {% endif %}
                          </div>
                            
                            
                            
    
                        </form>
                            
                        

                      </div>
                    
                    {% endfor %}
                    

                    
                
                  </div>
                </div>
              </div>
              
            </div>


          </div>
    </div>

    <script src="{% static '/jquery-3.6.0.js' %}"></script>
    <script src="{% static '/popper.min.js' %}"></script>
    <script src="{% static '/bootstrap-5.1.3-dist/js/bootstrap.js' %}"></script>

    {{data_empleado|json_script:"data_empleado"}}


    <script>

      const estado_solucion =  document.getElementById('estado-solucion')
      const comentario_departamental =  document.getElementById('comentario-departamental')

      if(estado_solucion)
      estado_solucion.addEventListener("input", e => {
        if(e.target.value == "RESUELTO"){
          comentario_departamental.removeAttribute('required')
        } else {
          comentario_departamental.setAttribute('required', '')
        }
      });

      const data_empleado = JSON.parse(document.getElementById('data_empleado').textContent) 
      const turnosSiguientes = document.getElementById('turnos-siguientes')
      const turnosPreferenciales = document.getElementById('turnos-preferenciales')

      const ws = new WebSocket('ws://' + window.location.host + '/turnos/');

      ws.onopen = function (e) {
      

      };


      let turnosSiendoAtendidos = []
      let turnosEnEspera = []

      const turnoActual = document.getElementById('turno-actual')

          ws.onmessage = function (e) {

              const data = JSON.parse(e.data);

              if(data.turnos_en_espera){

                for (let turno_en_espera of data.turnos_en_espera) {

                  if(turno_en_espera.direccion_servicio == data_empleado.direccion && turno_en_espera.departamento_servicio == data_empleado.departamento && turno_en_espera.division_departamento_servicio == data_empleado.division){
                    
                    if(turno_en_espera.preferencial){ //turnos preferenciales
                      let turno = document.createElement('div');
                      turno.id = turno_en_espera.codigo
                      turno.classList.add("card", "text-center", "bg-light", "my-2")

                      let atenderTurnoDisplay; //para evitar que se atienda el siguiente turno... si el actual no se ha finalizado, el boton de atender tendra display none
                      if(turnoActual){
                        atenderTurnoDisplay = 'd-none'
                      } else {
                        if(turnosPreferenciales.innerHTML.trim() != ''){ //esta condicion es para agregar el boton de atender si es el primer turno en la lista
                        
                          atenderTurnoDisplay = 'd-none'
                        } else {
                          atenderTurnoDisplay = ''
                      }
                      
                      }

                      let turnoInfo = `
                          <div class="card-body">
                            <h5 class="card-title fs-3 text-warning"><b>${turno_en_espera.codigo}</b></h5>
                            <p class="card-text fs-5"><strong>${turno_en_espera.nombre_persona_atendida}</strong></p>
                            <p class="card-text fs-5">Hora registro: ${turno_en_espera.hora_registro}</p>
                            
                            <p class="card-text fs-5">Comentario Recepcion: ${turno_en_espera.comentarios}</p>
                                                
                          </div>

                      `

                      let atenderForm = `<form method="post" id="atender-turno-preferencial-form">
                                          {% csrf_token %}
                                          <input type="text" value="${turno_en_espera.codigo}" class="d-none" id="codigo" name="codigo">


                                          <div class="card-footer text-muted">

                                            <input type="submit" class="btn btn-warning ${atenderTurnoDisplay}" value="Atender" name="atender-turno" id="atender-turno-preferencial-submit-button">

                                          </div>

                                        </form>`
                      

                      turno.innerHTML = turnoInfo + atenderForm


                      turnosPreferenciales.append(turno)

                    } else {
                      let turno = document.createElement('div');
                      turno.id = turno_en_espera.codigo
                      turno.classList.add("card", "text-center", "bg-light", "my-2")

                      let atenderTurnoDisplay; //para evitar que se atienda el siguiente turno... si el actual no se ha finalizado, el boton de atender tendra display none
                      if(turnoActual){
                        atenderTurnoDisplay = 'd-none'
                      } else {

                        if(turnosSiguientes.innerHTML.trim() != ''){ //esta condicion es para agregar el boton de atender si es el primer turno en la lista
                        
                          atenderTurnoDisplay = 'd-none'
                        } else {
                          atenderTurnoDisplay = ''
                        }
                        
                      }


                      let turnoInfo = `
                          <div class="card-body">
                            <h5 class="card-title fs-3 text-primary"><b>${turno_en_espera.codigo}</b></h5>
                            <p class="card-text fs-5"><strong>${turno_en_espera.nombre_persona_atendida}</strong></p>
                            <p class="card-text fs-5">Hora registro: ${turno_en_espera.hora_registro}</p>
                            
                            <p class="card-text fs-5">Comentario Recepcion: ${turno_en_espera.comentarios}</p>
                                                
                          </div>
                      `

                      let atenderForm = `<form method="post" id="atender-turno-form">
                                          {% csrf_token %}
                                          <input type="text" value="${turno_en_espera.codigo}" class="d-none" id="codigo" name="codigo">


                                          <div class="card-footer text-muted">

                                            <input type="submit" class="btn btn-primary ${atenderTurnoDisplay}" value="Atender" name="atender-turno" id="atender-turno-submit-button">

                                          </div>

                                        </form>`

                      
                      turno.innerHTML = turnoInfo + atenderForm
                      

                      turnosSiguientes.append(turno)
                    }

                    


                  }

                } 
              
              } 

              if(data.turnos_siendo_atendidos){

                for (let turno_siendo_atendido of data.turnos_siendo_atendidos) {

                  let turnoABorrar = document.getElementById(turno_siendo_atendido.codigo)

                  if(turnoABorrar){
                    turnoABorrar.remove() // borrar el turno de la lista porque ya comenzo a atenderlo otra persona

                    //hay que asegurarnos de que el boton de atender se le agregre al primer turno de la lista si no lo tiene al borrar un turno con el websocket
                    if(turnoActual){ // si el turno actual existe no pasa nada
                      
                      
                    } else { 
                      if(turnosSiguientes.firstChild){ //para asignar el boton al primer turno si el turno actual no existe

                        const cardFooterTurno = turnosSiguientes.querySelector('.card-footer')
                        cardFooterTurno.firstElementChild.classList.remove('d-none')
                        cardFooterTurno.firstElementChild.setAttribute("disabled", "")

                        let counter = 9

                        let conteoRegresivo = setInterval(() => { //para hacer conteo regresivo de disponibilidad del boton
                          cardFooterTurno.firstElementChild.value = counter
                          counter -= 1
                        }, 1000);

                        
                        setTimeout(() => { //habilitar el boton despues de 10 segundos
                          clearInterval(conteoRegresivo);
                          cardFooterTurno.firstElementChild.removeAttribute("disabled")
                          cardFooterTurno.firstElementChild.value = 'Atender'
                          
                        }, 10000);
                      }

                      if(turnosPreferenciales.firstChild){ //lo mismo que el bloque anterior para los turnos preferenciales
                        const cardFooterTurno = turnosPreferenciales.querySelector('.card-footer')
                        cardFooterTurno.firstElementChild.classList.remove('d-none')
                        cardFooterTurno.firstElementChild.setAttribute("disabled", "")

                        let counter = 9

                        let conteoRegresivo = setInterval(() => { //para hacer conteo regresivo de disponibilidad del boton
                          cardFooterTurno.firstElementChild.value = counter
                          counter -= 1
                        }, 1000);

                        
                        setTimeout(() => { //habilitar el boton despues de 10 segundos
                          clearInterval(conteoRegresivo);
                          cardFooterTurno.firstElementChild.removeAttribute("disabled")
                          cardFooterTurno.firstElementChild.value = 'Atender'
                          
                        }, 10000);

                      }


                    }

                    break;
                  }

                  const botonAtenderTurnoPreferencial = document.getElementById('atender-turno-preferencial-submit-button') 
                  const botonAtenderTurno = document.getElementById('atender-turno-submit-button') 

                  if(turno_siendo_atendido.direccion_servicio == data_empleado.direccion && turno_siendo_atendido.departamento_servicio == data_empleado.departamento && turno_siendo_atendido.division_departamento_servicio == data_empleado.division){
                    if(botonAtenderTurnoPreferencial){
                      // botonAtenderTurnoPreferencial.setAttribute("disabled", "");

                      let counter = 10

                      setInterval(() => { //para hacer conteo regresivo de disponibilidad del boton
                        botonAtenderTurnoPreferencial.textContent = counter
                        counter -= 1
                      }, 1000);

                      setTimeout(() => { //habilitar el boton despues de 10 segundos
                        // botonAtenderTurnoPreferencial.removeAttribute("disabled");
                        botonAtenderTurnoPreferencial.textContent = 'Atender'
                      }, 10000);
                    }
                    

                    if(botonAtenderTurno){

                      // botonAtenderTurno.setAttribute("disabled", "");

                      let counter = 10

                      setInterval(() => { //para hacer conteo regresivo de disponibilidad del boton
                        botonAtenderTurno.textContent = counter
                        counter -= 1
                      }, 1000);

                      setTimeout(() => { //habilitar el boton despues de 10 segundos
                        // botonAtenderTurno.removeAttribute("disabled");
                        botonAtenderTurno.textContent = 'Atender'
                      }, 10000);
                    }
                    
                  }
                  
                  

                }

              }





              
              
              
          };

      
    </script>

  </body>
</html>
